2017-04-05  Guilherme Iscaro  <iscaro@profusion.mobi>

        Do not use BLX for immediates (ARM-32)

        https://bugs.webkit.org/show_bug.cgi?id=170351

        Reviewed by Mark Lam.

        Currently the offline asm generator for 32-bit ARM code translates the
        'call' meta-instruction (which may be found in LowLevelInterpreter.asm
        and friends) to the ARM's BLX instrunction. The BLX instruction may be
        used for labels (immediates) and registers and one side effect of BLX
        is that it may switch the processor's instruction set.
        A 'BLX register' instruction will change/remain the processor state to
        ARM if the  register_bit[0] is set to 0 or change/remain to Thumb if
        register_bit[0] is set to 1. However, a 'BLX label' instruction will
        always switch the processor state. It switches ARM to thumb and vice-versa.
        This behaviour is unwanted, since the C++ code and the offlineasm generated code
        are both compiled using the same instruction set, thus a instruction
        set change will likely produce a crash. In order to fix the problem the
        BL instruction can be used for labels. It will branch just like BLX,
        but it won't change the instruction set. It's important to note that
        Darwin is not affected by this problem, thus to minimize the impact of
        this change the BL instruction will only be used on non-darwin targets.

        BLX reference: http://infocenter.arm.com/help/topic/com.arm.doc.dui0489i/CIHBJCDC.html?resultof=%22%62%6c%78%22%20

        * offlineasm/arm.rb:

2016-12-23  Mark Lam  <mark.lam@apple.com>

        Using Option::breakOnThrow() shouldn't crash while printing a null CodeBlock.
        https://bugs.webkit.org/show_bug.cgi?id=166466

        Reviewed by Keith Miller.

        * runtime/VM.cpp:
        (JSC::VM::throwException):

2017-05-09  Jason Marcell  <jmarcell@apple.com>

        Cherry-pick r215748. rdar://problem/31971413

    2017-04-25  Mark Lam  <mark.lam@apple.com>

            Local CSE wrongly CSEs array accesses with different result types.
            https://bugs.webkit.org/show_bug.cgi?id=170990
            <rdar://problem/31705945>

            Reviewed by Saam Barati.

            The fix is to use different LocationKind enums for the different type of array
            result types.  This makes the HeapLocation values different based on the result
            types, and allows CSE to discern between them.

            * dfg/DFGCSEPhase.cpp:
            * dfg/DFGClobberize.h:
            (JSC::DFG::clobberize):
            * dfg/DFGHeapLocation.cpp:
            (WTF::printInternal):
            * dfg/DFGHeapLocation.h:
            (JSC::DFG::indexedPropertyLocForResultType):

2017-05-09  Matthew Hanson  <matthew_hanson@apple.com>

        Cherry-pick r215351. rdar://problem/31631922

    2017-04-13  Mark Lam  <mark.lam@apple.com>

            Should use flushDirect() when flushing the scopeRegister due to needsScopeRegister().
            https://bugs.webkit.org/show_bug.cgi?id=170661
            <rdar://problem/31579046>

            Reviewed by Filip Pizlo.

            Previously, we were using flush() to flush the outermost frame's scopeRegister.
            This is incorrect because flush() expects the VirtualRegister value passed to
            it to be that of the top most inlined frame.  In the event that we reach a
            terminal condition while inside an inlined frame, flush() will end up flushing
            the wrong register.  The fix is simply to use flushDirect() instead.

            * dfg/DFGByteCodeParser.cpp:
            (JSC::DFG::ByteCodeParser::flush):

2016-10-11  Mark Lam  <mark.lam@apple.com>

        Array.prototype.concat should not modify frozen objects.
        https://bugs.webkit.org/show_bug.cgi?id=163302

        Reviewed by Filip Pizlo.

        The ES6 spec for Array.prototype.concat states that it uses the
        CreateDataPropertyOrThrow() to add items to the result array.  The spec for
        CreateDataPropertyOrThrow states:

        "This abstract operation creates a property whose attributes are set to the same
        defaults used for properties created by the ECMAScript language assignment
        operator. Normally, the property will not already exist. If it does exist and is
        not configurable or if O is not extensible, [[DefineOwnProperty]] will return
        false causing this operation to throw a TypeError exception."

        Since the properties of frozen objects are not extensible, not configurable, and
        not writable, Array.prototype.concat should fail to write to the result array if
        it is frozen.

        Ref: https://tc39.github.io/ecma262/#sec-array.prototype.concat,
        https://tc39.github.io/ecma262/#sec-createdatapropertyorthrow, and
        https://tc39.github.io/ecma262/#sec-createdataproperty.

        The fix consists of 2 parts:
        1. moveElement() should use the PutDirectIndexShouldThrow mode when invoking
           putDirectIndex(), and
        2. SparseArrayValueMap::putDirect() should check for the case where the property
           is read only.

        (2) ensures that we don't write into a non-writable property.
        (1) ensures that we throw a TypeError for attempts to write to a non-writeable
        property.

        * runtime/ArrayPrototype.cpp:
        (JSC::moveElements):
        * runtime/SparseArrayValueMap.cpp:
        (JSC::SparseArrayValueMap::putDirect):

2017-03-28  Jason Marcell  <jmarcell@apple.com>

        Merge r214240. rdar://problem/31178794

    2017-03-21  Mark Lam  <mark.lam@apple.com>

            The DFG Integer Check Combining phase should force an OSR exit for CheckInBounds on a negative constant min bound.
            https://bugs.webkit.org/show_bug.cgi?id=169933
            <rdar://problem/31105125>

            Reviewed by Filip Pizlo and Geoffrey Garen.

            Also fixed the bit-rotted RangeKey::dump() function.

            * dfg/DFGIntegerCheckCombiningPhase.cpp:
            (JSC::DFG::IntegerCheckCombiningPhase::handleBlock):

2017-02-23  Filip Pizlo  <fpizlo@apple.com>

        verifyEdges should not run in release
        <rdar://problem/30537798>

        Reviewed by Keith Miller and Mark Lam.

        * dfg/DFGAbstractInterpreterInlines.h:
        (JSC::DFG::AbstractInterpreter<AbstractStateType>::executeEffects):

2017-02-23  Filip Pizlo  <fpizlo@apple.com>

        Disable concurrent GC A:B testing.

        * runtime/Options.h:

2017-02-16  Keith Miller  <keith_miller@apple.com>

        Fix merge issue with r212085 (rdar://problem/29939864).

        * runtime/JSFunction.cpp:
        (JSC::JSFunction::callerGetter):

2017-02-09  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r212023. rdar://problem/30041640

    2017-02-09  Brent Fulgham  <bfulgham@apple.com>

            Handle synchronous layout when setting a selection range
            https://bugs.webkit.org/show_bug.cgi?id=167092
            <rdar://problem/30041640>

            Reviewed by Antti Koivisto.

            The 'innerTextElement' of a form control can change during layout due
            to arbitrary JavaScript executing. Handle the case where the inner text
            element has changed so that current render box height is while setting
            a selection range.

            Test: fast/forms/input-type-change-during-selection.html

            * html/HTMLTextFormControlElement.cpp:
            (WebCore::HTMLTextFormControlElement::setSelectionRange):

2017-02-09  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r212009. rdar://problem/29939864

    2017-02-09  Keith Miller  <keith_miller@apple.com>

            We should not allow Function.caller to be used on native functions
            https://bugs.webkit.org/show_bug.cgi?id=165628

            Reviewed by Mark Lam.

            Also remove unneeded dynamic cast.

            * runtime/JSFunction.cpp:
            (JSC::RetrieveCallerFunctionFunctor::RetrieveCallerFunctionFunctor):
            (JSC::JSFunction::callerGetter):

2017-02-02  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r211463. rdar://problem/30296879

    2017-01-31  Filip Pizlo  <fpizlo@apple.com>

            Make verifyEdge a RELEASE_ASSERT
            <rdar://problem/30296879>

            Rubber stamped by Saam Barati.

            * dfg/DFGAbstractInterpreterInlines.h:
            (JSC::DFG::AbstractInterpreter<AbstractStateType>::executeEffects):

2017-01-24  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r210971. rdar://problem/30115838

    2017-01-20  Saam Barati  <sbarati@apple.com>

            We should flash a safepoint before each DFG/FTL phase
            https://bugs.webkit.org/show_bug.cgi?id=167234

            Reviewed by Filip Pizlo.

            The recent GC changes caused us to regress Kraken because of a
            longstanding issue that happened to be hit with higher frequency because
            of a change in timing between when a particular GC was happening and
            when a particular FTL compilation was happening. The regression is caused
            by the GC was waiting for a large function to make it through the DFG portion
            of an FTL compilation. This was taking 20ms-30ms and started happened during a
            particular test with much higher frequency.

            This means that anytime the GC waits for this compilation, the test ran at least
            ~20ms slower because the GC waits for the compiler threads the mutator is stopped.

            It's good that we have such an easily reproducible case of this performance
            issue because it will effect many real JS programs, especially ones with
            large functions that get hot.

            The most straight forward solution to fix this is to flash a safepoint before
            each phase, allowing the GC to suspend the compiler if needed. In my testing,
            this progresses Kraken in the browser, and doesn't regress anything else. This
            solution also makes the most sense. I did some analysis on the compilation time
            of this function that took ~20-30ms to pass through the DFG phases, and
            the phase times were mostly evenly distributed. Some took longer than others,
            but no phase was longer than 3ms. Most were in the 0.25ms to 1.5ms range.

            * dfg/DFGPlan.cpp:
            (JSC::DFG::Plan::compileInThreadImpl):
            * dfg/DFGSafepoint.cpp:
            (JSC::DFG::Safepoint::begin):
            * runtime/Options.h:

2017-01-18  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r210858. rdar://problem/30069096

    2017-01-18  Filip Pizlo  <fpizlo@apple.com>

            JSObjectSetPrivate should not use jsCast<>
            rdar://problem/30069096

            Reviewed by Keith Miller.

            * API/JSObjectRef.cpp:
            (JSObjectSetPrivate):

2017-01-09  Babak Shafiei  <bshafiei@apple.com>

        Merge r210458. rdar://problem/29911919

    2017-01-06  Mark Lam  <mark.lam@apple.com>

            The ObjC API's JSVirtualMachine's map tables need to be guarded by a lock.
            https://bugs.webkit.org/show_bug.cgi?id=166778
            <rdar://problem/29761198>

            Reviewed by Filip Pizlo.

            Now that we have a concurrent GC, access to JSVirtualMachine's
            m_externalObjectGraph and m_externalRememberedSet need to be guarded by a lock
            since both the GC marker thread and the mutator thread may access them at the
            same time.

            * API/JSVirtualMachine.mm:
            (-[JSVirtualMachine addExternalRememberedObject:]):
            (-[JSVirtualMachine addManagedReference:withOwner:]):
            (-[JSVirtualMachine removeManagedReference:withOwner:]):
            (-[JSVirtualMachine externalDataMutex]):
            (scanExternalObjectGraph):
            (scanExternalRememberedSet):

            * API/JSVirtualMachineInternal.h:
            - Deleted externalObjectGraph method.  There's no need to expose this.

2017-01-06  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r210276. rdar://problem/28867002

    2017-01-04  Saam Barati  <sbarati@apple.com>

            We don't properly handle exceptions inside the nativeCallTrampoline macro in the LLInt
            https://bugs.webkit.org/show_bug.cgi?id=163720

            Reviewed by Mark Lam.

            In the LLInt, we were incorrectly doing the exception check after the call.
            Before the exception check, we were unwinding to our caller's
            frame under the assumption that our caller was always a JS frame.
            This is incorrect, however, because our caller might be a C frame.
            One way that it can be a C frame is when C calls to JS, and JS tail
            calls to native. This patch fixes this bug by doing unwinding from
            the native callee's frame instead of its callers.

            * llint/LowLevelInterpreter32_64.asm:
            * llint/LowLevelInterpreter64.asm:

2017-01-06  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r210221. rdar://problem/29449474

    2017-01-01  Jeff Miller  <jeffm@apple.com>

            Update user-visible copyright strings to include 2017
            https://bugs.webkit.org/show_bug.cgi?id=166278

            Reviewed by Dan Bernstein.

            * Info.plist:

2016-10-27  Mark Lam  <mark.lam@apple.com>

        Merge r207518. rdar://problem/28216050, rdar://problem/28216232

    2016-10-18  Mark Lam  <mark.lam@apple.com>

            Invoking Object.prototype.__proto__ accessors directly should throw a TypeError.
            https://bugs.webkit.org/show_bug.cgi?id=154377
            <rdar://problem/27330808>

            Reviewed by Filip Pizlo and Saam Barati.

            In a scenario where we cache the __proto__ accessors in global variables, and
            later explicitly invoke those accessors as functions, the spec for Function Calls
            (see https://tc39.github.io/ecma262/#sec-function-calls) states that the function
            ref value is of type Reference, and base of ref is an Environment Record.  Then,
            it follows that the thisValue should be set to refEnv.WithBaseObject()
            (see section 4.b.ii of 12.3.4.1 at
            https://tc39.github.io/ecma262/#sec-function-calls-runtime-semantics-evaluation).

            refEnv in this case is the environment record that the cached accessors were
            found in i.e. the global object.  The WithBaseObject() of the global object is
            undefined (see details about WithBaseObject at
            https://tc39.github.io/ecma262/#sec-environment-records).

            Hence, the __proto__ accessors should see a thisValue of undefined, and throw
            TypeErrors.  See https://tc39.github.io/ecma262/#sec-get-object.prototype.__proto__,
            https://tc39.github.io/ecma262/#sec-set-object.prototype.__proto__,
            https://tc39.github.io/ecma262/#sec-toobject, and
            https://tc39.github.io/ecma262/#sec-requireobjectcoercible.

            In JSC's implementation, the callee needs to do a ToThis operation on the
            incoming "this" argument in order to get the specified thisValue.  The
            implementations of the __proto__ accessors were not doing this correctly.  This
            has now been fixed.

            * runtime/JSGlobalObjectFunctions.cpp:
            (JSC::globalFuncProtoGetter):
            (JSC::globalFuncProtoSetter):

2016-10-24  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r207623. rdar://problem/28857477

    2016-10-20  Keith Miller  <keith_miller@apple.com>

            Invalid assertion in arguments elimination
            https://bugs.webkit.org/show_bug.cgi?id=163740
            <rdar://problem/27911462>

            Reviewed by Michael Saboff.

            The DFGFTL's arguments elimination phase incorrectly asserted that a GetFromArguments' first
            child would always be a CreateDirectArguments.  While we only create the
            op_get_from_arguments bytecode pointing to a create_direct_arguments, its possible for a
            number of reasons that a DFG GetFromArguments may not point to a CreateDirectArguments. For
            example, if we are OSR entering in some function with direct arguments the
            CreateDirectArguments node might become ExtractOSREntryLocals.

            * dfg/DFGArgumentsEliminationPhase.cpp:

2016-10-12  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r206955. rdar://problem/28216236

    2016-10-08  Saam Barati  <sbarati@apple.com>

            HasIndexedProperty clobberize rule is wrong for Array::ForceOSRExit
            https://bugs.webkit.org/show_bug.cgi?id=159942
            <rdar://problem/27328836>

            Reviewed by Filip Pizlo.

            When HasIndexedProperty has a ForceOSRExit array mode, it should
            report to write to side state, like the ForceOSRExit node, and the
            other nodes with ForceOSRExit array mode.

            * dfg/DFGClobberize.h:
            (JSC::DFG::clobberize):

2016-10-12  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r204612. rdar://problem/28216278

    2016-08-18  Mark Lam  <mark.lam@apple.com>

            ScopedArguments is using the wrong owner object for a write barrier.
            https://bugs.webkit.org/show_bug.cgi?id=160976
            <rdar://problem/27328506>

            Reviewed by Keith Miller.

            * runtime/ScopedArguments.h:
            (JSC::ScopedArguments::setIndexQuickly):

2016-09-14  Babak Shafiei  <bshafiei@apple.com>

        Merge r205882. rdar://problem/28233331

    2016-09-13  Mark Lam  <mark.lam@apple.com>

            DFG NewArrayBuffer node should watch for "have a bad time" state change.
            https://bugs.webkit.org/show_bug.cgi?id=161927
            <rdar://problem/27995222>

            Reviewed by Geoffrey Garen.

            * dfg/DFGFixupPhase.cpp:
            (JSC::DFG::FixupPhase::fixupNode):

2016-09-13  Babak Shafiei  <bshafiei@apple.com>

        Merge r205895. rdar://problem/28287070

    2016-09-13  Michael Saboff  <msaboff@apple.com>

            Promises aren't resolved properly when making a ObjC API callback
            https://bugs.webkit.org/show_bug.cgi?id=161929

            Reviewed by Geoffrey Garen.

            When we go to call out to an Objective C function registered via the API,
            we first drop all JSC locks to make the call.  As part of dropping the locks,
            we drain the microtask queue that is used among other things for handling deferred
            promise resolution.  The DropAllLocks scope class that drops the locks while in
            scope, resets the current thread's AtomicStringTable to the default table.  This
            is wrong for two reasons, first it happens before we drain the microtask queue and
            second it isn't needed as JSLock::willReleaseLock() restores the current thread's
            AtomicStringTable to the table before the lock was acquired.

            In fact, the manipulation of the current thread's AtomicStringTable is already
            properly handled as a stack in JSLock::didAcquireLock() and willReleaseLock().
            Therefore the manipulation of the AtomicStringTable in DropAllLocks constructor
            and destructor should be removed.

            * API/tests/testapi.mm:
            (testObjectiveCAPIMain): Added a new test.
            * runtime/JSLock.cpp:
            (JSC::JSLock::DropAllLocks::DropAllLocks):
            (JSC::JSLock::DropAllLocks::~DropAllLocks):

2016-09-09  Babak Shafiei  <bshafiei@apple.com>

        Merge r204485. rdar://problem/27991572

    2016-08-15  Mark Lam  <mark.lam@apple.com>

            Make JSValue::strictEqual() handle failures to resolve JSRopeStrings.
            https://bugs.webkit.org/show_bug.cgi?id=160832
            <rdar://problem/27577556>

            Reviewed by Geoffrey Garen.

            Currently, JSValue::strictEqualSlowCaseInline() (and peers) will blindly try to
            access the StringImpl of a JSRopeString that fails to resolve its rope.  As a
            result, we'll crash with null pointer dereferences.

            We can fix this by introducing a JSString::equal() method that will do the
            equality comparison, but is aware of the potential failures to resolve ropes.
            JSValue::strictEqualSlowCaseInline() (and peers) will now call JSString::equal()
            instead of accessing the underlying StringImpl directly.

            Also added some exception checks.

            * JavaScriptCore.xcodeproj/project.pbxproj:
            * jit/JITOperations.cpp:
            * runtime/ArrayPrototype.cpp:
            (JSC::arrayProtoFuncIndexOf):
            (JSC::arrayProtoFuncLastIndexOf):
            * runtime/JSCJSValueInlines.h:
            (JSC::JSValue::equalSlowCaseInline):
            (JSC::JSValue::strictEqualSlowCaseInline):
            * runtime/JSString.cpp:
            (JSC::JSString::equalSlowCase):
            * runtime/JSString.h:
            * runtime/JSStringInlines.h: Added.
            (JSC::JSString::equal):

2016-09-09  Babak Shafiei  <bshafiei@apple.com>

        Merge r203381. rdar://problem/27860536

    2016-07-18  Anders Carlsson  <andersca@apple.com>

            WebKit nightly fails to build on macOS Sierra
            https://bugs.webkit.org/show_bug.cgi?id=159902
            rdar://problem/27365672

            Reviewed by Tim Horton.

            * icu/unicode/ucurr.h: Added.
            Add ucurr.h from ICU.

2016-09-09  Babak Shafiei  <bshafiei@apple.com>

        Merge r205192. rdar://problem/28097740

    2016-08-30  Alex Christensen  <achristensen@webkit.org>

            Fix WebInspectorUI in internal Windows build
            https://bugs.webkit.org/show_bug.cgi?id=161221
            rdar://problem/28019023

            Reviewed by Brent Fulgham and Joseph Pecoraro.

            * JavaScriptCore.vcxproj/JavaScriptCore.proj:

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r204570. rdar://problem/27991567

    2016-08-17  Mark Lam  <mark.lam@apple.com>

            Remove an invalid assertion in the DFG backend's GetById emitter.
            https://bugs.webkit.org/show_bug.cgi?id=160925
            <rdar://problem/27248961>

            Reviewed by Filip Pizlo.

            The DFG backend's GetById assertion that the node's prediction not be SpecNone
            is just plain wrong.  It assumes that we can never have a GetById node without a
            type prediction, but this is not true.  The following test case proves otherwise:

                function foo() {
                    "use strict";
                    return --arguments["callee"];
                }

            Will remove the assertion.  Nothing else needs to change as the DFG is working
            correctly without the assertion.

            * dfg/DFGSpeculativeJIT32_64.cpp:
            (JSC::DFG::SpeculativeJIT::compile):
            * dfg/DFGSpeculativeJIT64.cpp:
            (JSC::DFG::SpeculativeJIT::compile):

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r204362. rdar://problem/27991421

    2016-08-10  Michael Saboff  <msaboff@apple.com>

            Baseline GetByVal and PutByVal for cache ID stubs need to handle exceptions
            https://bugs.webkit.org/show_bug.cgi?id=160749

            Reviewed by Filip Pizlo.

            We were emitting "callOperation()" calls in emitGetByValWithCachedId() and
            emitPutByValWithCachedId() without linking the exception checks created by the
            code emitted.  This manifested itself in various ways depending on the processor.
            This is due to what the destination is for an unlinked branch.  On X86, an unlinked
            branch goes tot he next instructions.  On ARM64, we end up with an infinite loop
            as we branch to the same instruction.  On ARM we branch to 0 as the branch is to
            an absolute address of 0.

            Now we save the exception handler address for the original generated function and
            link the exception cases for these by-val stubs to this handler.

            * bytecode/ByValInfo.h:
            (JSC::ByValInfo::ByValInfo): Added the address of the exception handler we should
            link to.

            * jit/JIT.cpp:
            (JSC::JIT::link): Compute the linked exception handler address and pass it to
            the ByValInfo constructor.
            (JSC::JIT::privateCompileExceptionHandlers): Make sure that we generate the
            exception handler if we have any by-val handlers.

            * jit/JIT.h:
            Added a label for the exception handler.  We'll link this later for the
            by value handlers.

            * jit/JITPropertyAccess.cpp:
            (JSC::JIT::privateCompileGetByValWithCachedId):
            (JSC::JIT::privateCompilePutByValWithCachedId):
            Link exception branches to the exception handler for the main function.

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r204360. rdar://problem/27991577

    2016-08-10  Mark Lam  <mark.lam@apple.com>

            DFG's flushForTerminal() needs to add PhantomLocals for bytecode live locals.
            https://bugs.webkit.org/show_bug.cgi?id=160755
            <rdar://problem/27488507>

            Reviewed by Filip Pizlo.

            If the DFG sees that an inlined function will result in an OSR exit every time,
            it will treat all downstream blocks as dead.  However, it still needs to keep
            locals that are alive in the bytecode alive for the compiled function so that
            those locals are properly written to the stack by the OSR exit ramp.

            The existing code neglected to do this.  This patch remedies this issue.

            * dfg/DFGByteCodeParser.cpp:
            (JSC::DFG::ByteCodeParser::flushDirect):
            (JSC::DFG::ByteCodeParser::addFlushOrPhantomLocal):
            (JSC::DFG::ByteCodeParser::phantomLocalDirect):
            (JSC::DFG::ByteCodeParser::flushForTerminal):

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r203952. rdar://problem/27991571

    2016-07-30  Mark Lam  <mark.lam@apple.com>

            Assertion failure while setting the length of an ArrayClass array.
            https://bugs.webkit.org/show_bug.cgi?id=160381
            <rdar://problem/27328703>

            Reviewed by Filip Pizlo.

            When setting large length values, we're currently treating ArrayClass as a
            ContiguousIndexingType array.  This results in an assertion failure.  This is
            now fixed.

            There are currently only 2 places where we create arrays with indexing type
            ArrayClass: ArrayPrototype and RuntimeArray.  The fix in JSArray:;setLength()
            takes care of ArrayPrototype.

            RuntimeArray already checks for the setting of its length property, and will
            throw a RangeError.  Hence, there's no change is needed for the RuntimeArray.
            Instead, I added some test cases ensure that the check and throw behavior does
            not change without notice.

            * runtime/JSArray.cpp:
            (JSC::JSArray::setLength):
            * tests/stress/array-setLength-on-ArrayClass-with-large-length.js: Added.
            (toString):
            (assertEqual):
            * tests/stress/array-setLength-on-ArrayClass-with-small-length.js: Added.
            (toString):
            (assertEqual):

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r203853. rdar://problem/27991580

    2016-07-28  Mark Lam  <mark.lam@apple.com>

            ASSERTION FAILED in errorProtoFuncToString() when Error name is a single char string.
            https://bugs.webkit.org/show_bug.cgi?id=160324
            <rdar://problem/27389572>

            Reviewed by Keith Miller.

            The issue is that errorProtoFuncToString() was using jsNontrivialString() to
            generate the error string even when the name string can be a single character
            string.  This is incorrect.  We should be using jsString() instead.

            * runtime/ErrorPrototype.cpp:
            (JSC::errorProtoFuncToString):
            * tests/stress/errors-with-simple-names-or-messages-should-not-crash-toString.js: Added.

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r203834. rdar://problem/27991582

    2016-07-28  Mark Lam  <mark.lam@apple.com>

            StringView should have an explicit m_is8Bit field.
            https://bugs.webkit.org/show_bug.cgi?id=160282
            <rdar://problem/27327943>

            Reviewed by Benjamin Poulain.

            * tests/stress/string-joining-long-strings-should-not-crash.js: Added.
            (catch):

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r203802. rdar://problem/27991569

    2016-07-27  Benjamin Poulain  <bpoulain@apple.com>

            [JSC] Fix a bunch of use-after-free of DFG::Node
            https://bugs.webkit.org/show_bug.cgi?id=160228

            Reviewed by Mark Lam.

            FTL had a few places where we use a node after it has been
            deleted. The dangling pointers come from the SSA liveness information
            kept on the basic blocks.

            This patch fixes the issues I could find and adds liveness invalidation
            to help finding dependencies like these.

            * dfg/DFGBasicBlock.h:
            (JSC::DFG::BasicBlock::SSAData::invalidate):

            * dfg/DFGConstantFoldingPhase.cpp:
            (JSC::DFG::ConstantFoldingPhase::run):
            Constant folding phase was deleting nodes in the loop over basic blocks.
            The problem is the deleted nodes can be referenced by other blocks.
            When the abstract interpreter was manipulating the abstract values of those
            it was doing so on the dead nodes.

            * dfg/DFGConstantHoistingPhase.cpp:
            Just invalidation. Nothing wrong here since the useless nodes were
            kept live while iterating the blocks.

            * dfg/DFGGraph.cpp:
            (JSC::DFG::Graph::killBlockAndItsContents):
            (JSC::DFG::Graph::killUnreachableBlocks):
            (JSC::DFG::Graph::invalidateNodeLiveness):

            * dfg/DFGGraph.h:
            * dfg/DFGPlan.cpp:
            (JSC::DFG::Plan::compileInThreadImpl):
            We had a lot of use-after-free in LCIM because we were using the stale
            live nodes deleted by previous phases.

2016-08-30  Babak Shafiei  <bshafiei@apple.com>

        Merge r203798. rdar://problem/27991578

    2016-07-27  Keith Miller  <keith_miller@apple.com>

            concatAppendOne should allocate using the indexing type of the array if it cannot merge
            https://bugs.webkit.org/show_bug.cgi?id=160261
            <rdar://problem/27530122>

            Reviewed by Mark Lam.

            Before, if we could not merge the indexing types for copying, we would allocate the
            the array as ArrayWithUndecided. Instead, we should allocate an array with the original
            array's indexing type.

            * runtime/ArrayPrototype.cpp:
            (JSC::concatAppendOne):
            * tests/stress/concat-append-one-with-sparse-array.js: Added.

2016-08-29  Babak Shafiei  <bshafiei@apple.com>

        Merge r204572.

    2016-08-17  Geoffrey Garen  <ggaren@apple.com>

            Fixed a potential bug in MarkedArgumentBuffer.
            https://bugs.webkit.org/show_bug.cgi?id=160948
            <rdar://problem/27889416>

            Reviewed by Oliver Hunt.

            I haven't been able to produce an observable test case after some trying.

            * runtime/ArgList.cpp:
            (JSC::MarkedArgumentBuffer::addMarkSet): New helper function -- I broke
            this out from existing code for clarity, but the behavior is the same.

            (JSC::MarkedArgumentBuffer::expandCapacity): Ditto.

            (JSC::MarkedArgumentBuffer::slowAppend): Always addMarkSet() on the slow
            path. This is faster than the old linear scan, and I think it might
            avoid cases the old scan could miss.

            * runtime/ArgList.h:
            (JSC::MarkedArgumentBuffer::append): Account for the case where someone
            has called clear() or removeLast().

            (JSC::MarkedArgumentBuffer::mallocBase): No behavior change -- but it's
            clearer to test the buffers directly instead of inferring what they
            might be based on capacity.

2016-05-13  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r196490. rdar://problem/26270811

    2016-02-12  Filip Pizlo  <fpizlo@apple.com>

            Fast path in JSObject::defineOwnIndexedProperty() forgets to check for the posibility of a descriptor that doesn't have a value
            https://bugs.webkit.org/show_bug.cgi?id=154175
            rdar://problem/24291497

            Reviewed by Geoffrey Garen.

            * runtime/JSObject.cpp:
            (JSC::JSObject::defineOwnIndexedProperty): Fix the bug.
            * runtime/SparseArrayValueMap.cpp:
            (JSC::SparseArrayValueMap::putEntry): Catch the bug sooner in debug.
            (JSC::SparseArrayValueMap::putDirect):
            * tests/stress/sparse-define-empty-descriptor.js: Added. This used to crash in release.

2016-05-13  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r196240. rdar://problem/26271108

    2016-02-07  Filip Pizlo  <fpizlo@apple.com>

            String.match should defend against matches that would crash the VM
            https://bugs.webkit.org/show_bug.cgi?id=153964
            rdar://problem/24301119

            Reviewed by Saam Barati.

            This fixes a crash in an internal test case.

            * runtime/ArgList.cpp:
            (JSC::MarkedArgumentBuffer::slowAppend): Use best practices to ensure that the size we
                compute makes sense. Crash if it stops making sense, since most users of this API assume
                that they are creating something small enough to fit on the stack.
            * runtime/ArgList.h:
            (JSC::MarkedArgumentBuffer::~MarkedArgumentBuffer):
            (JSC::MarkedArgumentBuffer::size):
            (JSC::MarkedArgumentBuffer::operator new): Deleted. These were ineffective. According to the
                debugger, we were still calling system malloc. So, I changed the code to use fastMalloc()
                directly.
            (JSC::MarkedArgumentBuffer::operator delete): Deleted.
            * runtime/StringPrototype.cpp:
            (JSC::stringProtoFuncMatch): Explicitly defend against absurd sizes. Of course, it's still
                possible to crash the VM on OOME. That's sort of always been the philosophy of JSC - we
                don't guarantee that you'll get a nice-looking error whenever you run out of memory,
                since in a GC'd environment you can't really guarantee those things. But, if you have a
                match that obvious won't fit in memory, then reporting an error is useful in case this is
                a developer experimenting with a buggy regexp.

2016-05-12  Babak Shafiei  <bshafiei@apple.com>

        Merge patch for r200387.

    2016-05-03  Michael Saboff  <msaboff@apple.com>

            Crash: Array.prototype.slice() and .splice() can call fastSlice() after an array is truncated
            https://bugs.webkit.org/show_bug.cgi?id=157322

            Reviewed by Filip Pizlo.

            Check to see if the source array has changed length before calling fastSlice().
            If it has, take the slow path.

            * runtime/ArrayPrototype.cpp:
            (JSC::arrayProtoFuncSlice):
            (JSC::arrayProtoFuncSplice):
            * tests/stress/regress-157322.js: New test.

2016-05-11  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r199277. rdar://problem/26228546

    2016-04-09  Saam barati  <sbarati@apple.com>

            Allocation sinking SSA Defs are allowed to have replacements
            https://bugs.webkit.org/show_bug.cgi?id=156444

            Reviewed by Filip Pizlo.

            Consider the following program and the annotations that explain why
            the SSA defs we create in allocation sinking can have replacements.

            function foo(a1) {
                let o1 = {x: 20, y: 50};
                let o2 = {y: 40, o1: o1};
                let o3 = {};

                // We're Defing a new variable here, call it o3_field.
                // o3_field is defing the value that is the result of
                // a GetByOffset that gets eliminated through allocation sinking.
                o3.field = o1.y;

                dontCSE();

                // This control flow is here to not allow the phase to consult
                // its local SSA mapping (which properly handles replacements)
                // for the value of o3_field.
                if (a1) {
                    a1 = true;
                } else {
                    a1 = false;
                }

                // Here, we ask for the reaching def of o3_field, and assert
                // it doesn't have a replacement. It does have a replacement
                // though. The original Def was the GetByOffset. We replaced
                // that GetByOffset with the value of the o1_y variable.
                let value = o3.field;
                assert(value === 50);
            }

            * dfg/DFGObjectAllocationSinkingPhase.cpp:
            * tests/stress/allocation-sinking-defs-may-have-replacements.js: Added.
            (dontCSE):
            (assert):
            (foo):

2016-05-11  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r196524. rdar://problem/26228552

    2016-02-12  Filip Pizlo  <fpizlo@apple.com>

            JSObject::putByIndexBeyondVectorLengthWithoutAttributes needs to go to the sparse map based on MAX_STORAGE_VECTOR_INDEX
            https://bugs.webkit.org/show_bug.cgi?id=154201
            rdar://problem/24291387

            Reviewed by Saam Barati.

            I decided against adding a test for this, because it runs for a very long time.

            * runtime/JSObject.cpp:
            (JSC::JSObject::putByIndexBeyondVectorLengthWithoutAttributes): Fix the bug.
            * runtime/StringPrototype.cpp:
            (JSC::stringProtoFuncSplit): Fix a related bug: if this code creates an array that would have
                hit the above bug, then it would probably manifest as a spin or as swapping.

2016-03-24  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r198592. rdar://problem/25332806

    2016-03-23  Michael Saboff  <msaboff@apple.com>

            JavaScriptCore ArrayPrototype::join shouldn't cache butterfly when it makes effectful calls
            https://bugs.webkit.org/show_bug.cgi?id=155776

            Reviewed by Saam Barati.

            Array.join ends up calling toString, possibly on some object.  Since these calls
            could be effectful and could change the array itself, we can't hold the butterfly
            pointer while making effectful calls.  Changed the code to fall back to the general
            case when an effectful toString() call might be made.

            * runtime/ArrayPrototype.cpp:
            (JSC::join):
            * runtime/JSStringJoiner.h:
            (JSC::JSStringJoiner::appendWithoutSideEffects): New helper that doesn't make effectful
            toString() calls.
            (JSC::JSStringJoiner::append): Built upon appendWithoutSideEffects.

2016-02-26  Babak Shafiei  <bshafiei@apple.com>

        Merge patch for rdar://problem/24826901.

2016-02-12  Babak Shafiei  <bshafiei@apple.com>

        Merge patch for rdar://problem/24626412.

    2016-02-12  Brent Fulgham  <bfulgham@apple.com>

            [Win] Correct internal branch build failure.
            <rdar://problem/24626412>

            Work around some C++11 compiler limitations in VS2013. The new code
            brought into this branch from trunk included some things that the
            older compiler used on this branch does not support.

            * JavaScriptCore.vcxproj/JavaScriptCore.vcxproj.filters: Correct
            project file.
            * inspector/InspectorBackendDispatcher.cpp:
            (Inspector::castToInteger): Restored to work around compiler bug.
            (Inspector::castToNumber): Ditto.
            (Inspector::asString): Ditto.
            (Inspector::asBoolean): Ditto.
            (Inspector::asObject): Ditto.
            (Inspector::asArray): Ditto.
            (Inspector::asValue): Ditto.
            (Inspector::BackendDispatcher::getInteger): Add VS2013 workaround.
            (Inspector::BackendDispatcher::getString): Ditto.
            (Inspector::BackendDispatcher::getBoolean): Ditto.
            (Inspector::BackendDispatcher::getObject): Ditto.
            (Inspector::BackendDispatcher::getArray): Ditto.
            (Inspector::BackendDispatcher::getValue): Ditto.

2016-02-10  Babak Shafiei  <bshafiei@apple.com>

        Merge r196179.

    2016-02-05  Filip Pizlo  <fpizlo@apple.com>

            Arrayify for a typed array shouldn't create a monster
            https://bugs.webkit.org/show_bug.cgi?id=153908
            rdar://problem/24290639

            Reviewed by Mark Lam.

            Previously if you convinced the DFG to emit an Arrayify to ArrayStorage and then gave it a
            typed array, you'd corrupt the object.

            * runtime/JSArrayBufferView.cpp:
            (WTF::printInternal):
            * runtime/JSArrayBufferView.h:
            * runtime/JSGenericTypedArrayViewInlines.h:
            (JSC::JSGenericTypedArrayView<Adaptor>::visitChildren):
            (JSC::JSGenericTypedArrayView<Adaptor>::slowDownAndWasteMemory):
            * runtime/JSObject.cpp:
            (JSC::JSObject::copyButterfly):
            (JSC::JSObject::enterDictionaryIndexingMode):
            (JSC::JSObject::ensureInt32Slow):
            (JSC::JSObject::ensureDoubleSlow):
            (JSC::JSObject::ensureContiguousSlow):
            (JSC::JSObject::ensureArrayStorageSlow):
            (JSC::JSObject::growOutOfLineStorage):
            (JSC::getBoundSlotBaseFunctionForGetterSetter):
            * runtime/Structure.h:
            * tests/stress/arrayify-array-storage-typed-array.js: Added. This test failed.
            * tests/stress/arrayify-int32-typed-array.js: Added. This test case already had other protections, but we beefed them up.

2016-01-29  Babak Shafiei  <bshafiei@apple.com>

        Merge r194479.

    2016-01-01  Jeff Miller  <jeffm@apple.com>

            Update user-visible copyright strings to include 2016
            https://bugs.webkit.org/show_bug.cgi?id=152531

            Reviewed by Alexey Proskuryakov.

            * Info.plist:

2016-01-29  Babak Shafiei  <bshafiei@apple.com>

        Merge patch for rdar://problem/23968717.

    2016-01-28  Saam barati  <sbarati@apple.com>

            Inspector should remove cached code when it recompiles due to the Type Profiler being disabled.

            Keeping around cached code is a mistake because we then
            generate code that depends on the VM having a TypeProfiler
            when it doesn't. Note that VM::discardAllCode does exactly
            what we want.

            * inspector/agents/InspectorRuntimeAgent.cpp:
            (Inspector::InspectorRuntimeAgent::getRuntimeTypesForVariablesAtOffsets):
            (Inspector::recompileAllJSFunctionsForTypeProfiling):
            (Inspector::InspectorRuntimeAgent::willDestroyFrontendAndBackend):
            (Inspector::TypeRecompiler::visit): Deleted.
            (Inspector::TypeRecompiler::operator()): Deleted.

2016-01-27  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r194559. rdar://problem/24269083

    2016-01-04  Tim Horton  <timothy_horton@apple.com>

            Turn on gesture events when building for Yosemite
            https://bugs.webkit.org/show_bug.cgi?id=152704
            rdar://problem/24042472

            Reviewed by Anders Carlsson.

            * Configurations/FeatureDefines.xcconfig:

2016-01-27  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r193782. rdar://problem/24358367

    2015-12-08  Filip Pizlo  <fpizlo@apple.com>

            DFG::UnificationPhase should merge isProfitableToUnbox, since this may have been set in ByteCodeParser
            https://bugs.webkit.org/show_bug.cgi?id=152011
            rdar://problem/23777875

            Reviewed by Michael Saboff.

            Previously UnificationPhase did not merge this because we used to only set this in FixupPhase, which runs after unification. But now
            ByteCodeParser may set isProfitableToUnbox as part of how it handles the ArgumentCount of an inlined varargs call, so UnificationPhase
            needs to merge it after unifying.

            Also changed the order of unification since this makes the bug more obvious and easier to test.

            * dfg/DFGUnificationPhase.cpp:
            (JSC::DFG::UnificationPhase::run):
            * tests/stress/varargs-with-unused-count.js: Added.

2016-01-13  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r193939. rdar://problem/24154418

    2015-12-10  Daniel Bates  <dabates@apple.com>

            [CSP] eval() is not blocked for stringified literals
            https://bugs.webkit.org/show_bug.cgi?id=152158
            <rdar://problem/15775625>

            Reviewed by Saam Barati.

            Fixes an issue where stringified literals can be eval()ed despite being disallowed by
            Content Security Policy of the page.

            * interpreter/Interpreter.cpp:
            (JSC::eval): Throw a JavaScript EvalError exception if eval() is disallowed for the page
            and return undefined.
            * runtime/JSGlobalObjectFunctions.cpp:
            (JSC::globalFuncEval): Ditto.

2016-01-12  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r194704. rdar://problem/24043057

    2016-01-06  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: CRASH Attempting to pause on CSP violation not inside of script
            https://bugs.webkit.org/show_bug.cgi?id=152825
            <rdar://problem/24021276>

            Reviewed by Timothy Hatcher.

            * debugger/Debugger.cpp:
            (JSC::Debugger::breakProgram):
            We cannot pause if we are not evaluating JavaScript, so bail.

2016-01-12  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r194908. rdar://problem/24101253

    2016-01-11  Matthew Hanson  <matthew_hanson@apple.com>

            Merge r192186. rdar://problem/24101174

        2015-11-09  Joseph Pecoraro  <pecoraro@apple.com>

                Web Inspector: $0 stops working after navigating to a different domain
                https://bugs.webkit.org/show_bug.cgi?id=147962

                Reviewed by Brian Burg.

                Extract the per-GlobalObject cache of JSValue wrappers for
                InjectedScriptHost objects to be reused by WebCore for its
                CommandLineAPIHost objects injected into multiple contexts.

                * CMakeLists.txt:
                * JavaScriptCore.vcxproj/JavaScriptCore.vcxproj:
                * JavaScriptCore.vcxproj/JavaScriptCore.vcxproj.filters:
                * JavaScriptCore.xcodeproj/project.pbxproj:
                Add new files.

                * inspector/PerGlobalObjectWrapperWorld.h:
                * inspector/PerGlobalObjectWrapperWorld.cpp:
                (Inspector::PerGlobalObjectWrapperWorld::getWrapper):
                (Inspector::PerGlobalObjectWrapperWorld::addWrapper):
                (Inspector::PerGlobalObjectWrapperWorld::clearAllWrappers):
                Hold a bunch of per-global-object wrappers for an object
                that will outlive the global object. This inspector does this
                for host objects that it exposes into scripts it injects into
                each execution context created by the page.

                * inspector/InjectedScriptHost.cpp:
                (Inspector::InjectedScriptHost::wrapper):
                (Inspector::InjectedScriptHost::clearAllWrappers):
                (Inspector::InjectedScriptHost::jsWrapper): Deleted.
                (Inspector::clearWrapperFromValue): Deleted.
                (Inspector::InjectedScriptHost::clearWrapper): Deleted.
                Extract and simplify the Per-GlobalObject wrapping into a class.
                Simplify object construction as well.

                * inspector/InjectedScriptHost.h:
                * inspector/InjectedScriptManager.cpp:
                (Inspector::InjectedScriptManager::createInjectedScript):
                (Inspector::InjectedScriptManager::discardInjectedScripts):
                Make discarding virtual so subclasses may also discard injected scripts.

                * inspector/JSInjectedScriptHost.cpp:
                (Inspector::JSInjectedScriptHost::JSInjectedScriptHost):
                (Inspector::JSInjectedScriptHost::releaseImpl): Deleted.
                (Inspector::JSInjectedScriptHost::~JSInjectedScriptHost): Deleted.
                (Inspector::toJS): Deleted.
                (Inspector::toJSInjectedScriptHost): Deleted.
                * inspector/JSInjectedScriptHost.h:
                (Inspector::JSInjectedScriptHost::create):
                (Inspector::JSInjectedScriptHost::impl):
                Update this code originally copied from older generated bindings to
                be more like new generated bindings and remove some now unused code.

2015-12-17  Babak Shafiei  <bshafiei@apple.com>

        Merge r191343.

    2015-10-20  Tim Horton  <timothy_horton@apple.com>

            Try to fix the build by disabling MAC_GESTURE_EVENTS on 10.9 and 10.10

            * Configurations/FeatureDefines.xcconfig:

2015-12-17  Babak Shafiei  <bshafiei@apple.com>

        Merge r191305.

    2015-10-19  Tim Horton  <timothy_horton@apple.com>

            Try to fix the iOS build

            * Configurations/FeatureDefines.xcconfig:

2015-12-16  Babak Shafiei  <bshafiei@apple.com>

        Merge r191299.

    2015-10-19  Tim Horton  <timothy_horton@apple.com>

            Add magnify and rotate gesture event support for Mac
            https://bugs.webkit.org/show_bug.cgi?id=150179
            <rdar://problem/8036240>

            Reviewed by Darin Adler.

            * Configurations/FeatureDefines.xcconfig:
            New feature flag.

2015-12-11  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r193480. rdar://problem/23849785

    2015-12-04  Filip Pizlo  <fpizlo@apple.com>

            Having a bad time has a really awful time when it runs at the same time as the JIT
            https://bugs.webkit.org/show_bug.cgi?id=151882
            rdar://problem/23547038

            Unreviewed, really adding the test this time.

            * tests/stress/ftl-has-a-bad-time.js: Added.
            (foo):

2015-12-11  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r193470. rdar://problem/23849785

    2015-12-04  Filip Pizlo  <fpizlo@apple.com>

            Having a bad time has a really awful time when it runs at the same time as the JIT
            https://bugs.webkit.org/show_bug.cgi?id=151882
            rdar://problem/23547038

            Reviewed by Geoffrey Garen.

            The DFG's use of watchpoints for havingABadTime goes back a long time. We introduced this feature
            when we first introduced watchpoints. That left it open to a lot of bitrot. On top of that, this
            code doesn't get tested much because having a bad time is not something that is really supposed to
            happen.

            Well, now I've got reports that it does happen - or at least, we know that it is because of
            crashes in an assertion that could only be triggered if a bad time was had. In the meantime, we
            added two new features without adequately testing havingABadTime: concurrent JIT and FTL.
            Concurrency means that we have to worry about the havingABadTime watchpoint triggering during
            compilation. FTL means that we have new code and new optimizations that needs to deal with this
            feature correctly.

            The bug can arise via race condition or just goofy profiling. As in the newly added test, we could
            first profile an allocation thinking that it will allocate sane arrays. Then we might have a bad
            time, and then compile that function with the FTL. The ByteCodeParser will represent the
            allocation with a NewArray node that has a sane indexingType(). But when we go to lower the Node,
            we observe that the Structure* that the JSGlobalObject tells us to use has a different indexing
            type. This is a feature of havingABadTime that the DFG knew about, but the FTL didn't. The FTL
            didn't know about it because we didn't have adequate tests, and this code rarely gets triggered in
            the wild. So, the FTL had a silly assertion that the indexing types match. They absolutely don't
            have to match.

            There is another bug, a race condition, that remains even if we remove the bad assertion. We set
            the havingABadTime watchpoint late in compilation, and we do it based on whether the watchpoint is
            still OK. This means that we could parse a function before we have a bad time and then do
            optimizations (for example in AbstractInterpreter) like proving that the structure set associated
            with the value returned by the NewArray is the one with a sane indexing type. Then, after those
            optimizations have already been done, we will go to set the watchpoint. But just as we are doing
            this, we could haveABadTime on the main thread. Currently this sort of almost works because
            having a bad time requires doing a GC, and we can't GC until the watchpoint collection phase. But
            that feels too fragile. So, this phase moves the setting of the watchpoint to the FixupPhase. This
            is consistent with our long-term goal of removing the WatchpointCollectionPhase. Moving this to
            FixupPhase means that we set the watchpoint before doing any optimizations. So, if having a bad
            time happens before the FixupPhase then all optimizations will agree that we're having a bad time
            and so everything is fine; if we have a bad time after FixupPhase then we will cancel the
            compilation anyway.

            * dfg/DFGByteCodeParser.cpp:
            (JSC::DFG::ByteCodeParser::handleConstantInternalFunction):
            * dfg/DFGFixupPhase.cpp:
            (JSC::DFG::FixupPhase::fixupNode):
            (JSC::DFG::FixupPhase::watchHavingABadTime):
            (JSC::DFG::FixupPhase::createToString):
            * dfg/DFGNode.h:
            (JSC::DFG::Node::hasIndexingType):
            (JSC::DFG::Node::indexingType):
            * dfg/DFGWatchpointCollectionPhase.cpp:
            (JSC::DFG::WatchpointCollectionPhase::handle):
            * ftl/FTLLowerDFGToLLVM.cpp:
            (JSC::FTL::DFG::LowerDFGToLLVM::compileNewArray):
            (JSC::FTL::DFG::LowerDFGToLLVM::compileNewArrayBuffer):
            * tests/stress/ftl-has-a-bad-time.js: Added.

2015-12-04  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r192190. rdar://problem/23732407

    2015-11-09  Saam barati  <sbarati@apple.com>

            DFG::PutStackSinkingPhase should not treat the stack variables written by LoadVarargs/ForwardVarargs as being live
            https://bugs.webkit.org/show_bug.cgi?id=145295

            Reviewed by Filip Pizlo.

            This patch fixes PutStackSinkingPhase to no longer escape the stack
            locations that LoadVarargs and ForwardVarargs write to. We used
            to consider sinking PutStacks right before a LoadVarargs/ForwardVarargs
            because we considered them uses of such stack locations. They aren't
            uses of those stack locations, they unconditionally write to those
            stack locations. Sinking PutStacks to these nodes was not needed before,
            but seemed mostly innocent. But I ran into a problem with this while implementing
            FTL try/catch where we would end up having to generate a value for a sunken PutStack
            right before a LoadVarargs. This would cause us to issue a GetStack that loaded garbage that
            was then forwarded into a Phi that was used as the source as the PutStack. This caused the
            abstract interpreter to confuse itself on type information for the garbage GetStack
            that was fed into the Phi, which would cause the abstract interpreter to then claim
            that the basic block with the PutStack in it would never be reached. This isn't true, the
            block would indeed be reached. The solution here is to be more precise about the
            liveness of locals w.r.t LoadVarargs and ForwardVarargs.

            * dfg/DFGPreciseLocalClobberize.h:
            (JSC::DFG::PreciseLocalClobberizeAdaptor::PreciseLocalClobberizeAdaptor):
            (JSC::DFG::PreciseLocalClobberizeAdaptor::write):
            * dfg/DFGPutStackSinkingPhase.cpp:
            * dfg/DFGSSACalculator.h:

2015-12-04  Timothy Hatcher  <timothy@apple.com>

        Merge r192391. rdar://problem/23221163

    2015-11-12  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Reduce list of saved console messages
            https://bugs.webkit.org/show_bug.cgi?id=151225

            Reviewed by Geoffrey Garen.

            Inspector saves messages so that when an inspector frontend opens it can report
            these messages to the frontend. However we were saving a rather large list of
            1000 messages. Most pages do not produce a large number of console messages.
            However pages that live for a long time can generate many errors over time,
            especially periodic engine issues such as cross-origin access errors. This could
            result in a lot of wasted memory for console messages that may never be used.

            Likewise when an inspector first open sending all 1000 messages to the frontend
            results in a poor experience.

            Lets reduce the list of saved messages. Developer will still be able to see
            all messages as long as they have Web Inspector open at the time the messages
            are generated.

            * inspector/agents/InspectorConsoleAgent.cpp:
            Reduce the list from 1000 to 100. Also, when expiring
            messages from this list, chunk in 10s instead of 100s.

2015-12-04  Timothy Hatcher  <timothy@apple.com>

        Merge r191397. rdar://problem/23221163

    2015-10-21  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Array previews with Symbol objects have too few preview values
            https://bugs.webkit.org/show_bug.cgi?id=150404

            Reviewed by Timothy Hatcher.

            * inspector/InjectedScriptSource.js:
            (InjectedScript.RemoteObject.prototype._appendPropertyPreviews):
            We should be continuing inside this loop not returning.

2015-12-04  Timothy Hatcher  <timothy@apple.com>

        Merge r188976. rdar://problem/23221163

    2015-08-26  Brian Burg  <bburg@apple.com>

            Web Inspector: REGRESSION(r188965): BackendDispatcher loses request ids when called re-entrantly
            https://bugs.webkit.org/show_bug.cgi?id=148480

            Reviewed by Joseph Pecoraro.

            I added an assertion that m_currentRequestId is Nullopt when dispatch() is called, but this should
            not hold if dispatching a backend command while debugger is paused. I will remove the assertion
            and add proper scoping for all dispatch() branches.

            No new tests, this wrong assert caused inspector/dom-debugger/node-removed.html to crash reliably.

            * inspector/InspectorBackendDispatcher.cpp:
            (Inspector::BackendDispatcher::dispatch): Cover each exit with an appropriate TemporaryChange scope.

2015-12-04  Timothy Hatcher  <timothy@apple.com>

        Merge r188656. rdar://problem/23221163

    2015-08-19  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Unexpected node preview format for an element with newlines in className attribute
            https://bugs.webkit.org/show_bug.cgi?id=148192

            Reviewed by Brian Burg.

            * inspector/InjectedScriptSource.js:
            (InjectedScript.prototype._nodePreview):
            Replace whitespace blocks with single spaces to produce a simpler class string for previews.

2015-12-04  Timothy Hatcher  <timothy@apple.com>

        Merge r187897. rdar://problem/23221163

    2015-08-04  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Object previews for SVG elements shows SVGAnimatedString instead of text
            https://bugs.webkit.org/show_bug.cgi?id=147328

            Reviewed by Timothy Hatcher.

            * inspector/InjectedScriptSource.js:
            Use classList and classList.toString instead of className.

2015-12-03  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r188530. rdar://problem/23732374

    2015-08-17  Simon Fraser  <simon.fraser@apple.com>

            will-change should sometimes trigger compositing
            https://bugs.webkit.org/show_bug.cgi?id=148072

            Reviewed by Tim Horton.

            Include will-change as a reason for compositing.

            * inspector/protocol/LayerTree.json:

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r191967. rdar://problem/23221163

    2015-11-03  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Handle or Remove ParseHTML Timeline Event Records
            https://bugs.webkit.org/show_bug.cgi?id=150689

            Reviewed by Timothy Hatcher.

            * inspector/protocol/Timeline.json:

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r191692. rdar://problem/23221163

    2015-10-28  Timothy Hatcher  <timothy@apple.com>

            Web Inspector: jsmin.py mistakenly removes whitespace from template literal strings
            https://bugs.webkit.org/show_bug.cgi?id=148728

            Reviewed by Joseph Pecoraro.

            * Scripts/jsmin.py:
            (JavascriptMinify.minify): Make backtick a quoting character.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r191651. rdar://problem/23221163

    2015-10-27  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Remove Timeline MarkDOMContent and MarkLoad, data is already available
            https://bugs.webkit.org/show_bug.cgi?id=150615

            Reviewed by Timothy Hatcher.

            * inspector/protocol/Timeline.json:

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r191355. rdar://problem/23221163

    2015-10-20  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: JavaScriptCore should parse sourceURL and sourceMappingURL directives
            https://bugs.webkit.org/show_bug.cgi?id=150096

            Reviewed by Geoffrey Garen.

            * inspector/ContentSearchUtilities.cpp:
            (Inspector::ContentSearchUtilities::scriptCommentPattern): Deleted.
            (Inspector::ContentSearchUtilities::findScriptSourceURL): Deleted.
            (Inspector::ContentSearchUtilities::findScriptSourceMapURL): Deleted.
            * inspector/ContentSearchUtilities.h:
            No longer need to search script content.

            * inspector/ScriptDebugServer.cpp:
            (Inspector::ScriptDebugServer::dispatchDidParseSource):
            Carry over the sourceURL and sourceMappingURL from the SourceProvider.

            * inspector/agents/InspectorDebuggerAgent.cpp:
            (Inspector::InspectorDebuggerAgent::sourceMapURLForScript):
            (Inspector::InspectorDebuggerAgent::didParseSource):
            No longer do content searching.

            * parser/Lexer.cpp:
            (JSC::Lexer<T>::setCode):
            (JSC::Lexer<T>::skipWhitespace):
            (JSC::Lexer<T>::parseCommentDirective):
            (JSC::Lexer<T>::parseCommentDirectiveValue):
            (JSC::Lexer<T>::consume):
            (JSC::Lexer<T>::lex):
            * parser/Lexer.h:
            (JSC::Lexer::sourceURL):
            (JSC::Lexer::sourceMappingURL):
            (JSC::Lexer::sourceProvider): Deleted.
            Give lexer the ability to detect script comment directives.
            This just consumes characters in single line comments and
            ultimately sets the sourceURL or sourceMappingURL found.

            * parser/Parser.h:
            (JSC::Parser<LexerType>::parse):
            * parser/SourceProvider.h:
            (JSC::SourceProvider::url):
            (JSC::SourceProvider::sourceURL):
            (JSC::SourceProvider::sourceMappingURL):
            (JSC::SourceProvider::setSourceURL):
            (JSC::SourceProvider::setSourceMappingURL):
            After parsing a script, update the Source Provider with the
            value of directives that may have been found in the script.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r190542. rdar://problem/23221163

    2015-10-02  Matt Baker  <mattbaker@apple.com>

            Web Inspector: Add breakpoint option to ignore n times before stopping
            https://bugs.webkit.org/show_bug.cgi?id=147664

            Reviewed by Timothy Hatcher.

            * debugger/Breakpoint.h:
            (JSC::Breakpoint::Breakpoint):
            Added ignoreCount and hitCount fields. Cleaned up initializers.

            * debugger/Debugger.cpp:
            (JSC::Debugger::hasBreakpoint):
            If a breakpoint matches the current text position, increment breakpoint hit count and
            compare with ignore count before testing the breakpoint condition.

            * inspector/ScriptBreakpoint.h:
            (Inspector::ScriptBreakpoint::ScriptBreakpoint):
            Added ignoreCount field. Cleaned up initializers.

            * inspector/ScriptDebugServer.cpp:
            (Inspector::ScriptDebugServer::setBreakpoint):
            Added ignoreCount field.

            * inspector/agents/InspectorDebuggerAgent.cpp:
            (Inspector::buildObjectForBreakpointCookie):
            (Inspector::InspectorDebuggerAgent::setBreakpointByUrl):
            (Inspector::InspectorDebuggerAgent::setBreakpoint):
            (Inspector::InspectorDebuggerAgent::continueToLocation):
            (Inspector::InspectorDebuggerAgent::didParseSource):
            Plumbing for ignoreCount property.

            * inspector/protocol/Debugger.json:
            Added optional ignoreCount property to BreakpointOptions object.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r190146. rdar://problem/23221163

    2015-09-22  Saam barati  <sbarati@apple.com>

            Web Inspector: [ES6] Improve Type Profiler Support for Arrow Functions
            https://bugs.webkit.org/show_bug.cgi?id=143171

            Reviewed by Joseph Pecoraro.

            We now need to take into account TypeProfilerSearchDescriptor when
            hashing results for type profiler queries. Before, we've gotten
            away with not doing this because before we would never have a text
            collision between a return type text offset and a normal expression text
            offset. But, with arrow functions, we will have collisions when
            the arrow function doesn't have parens around its single parameter.
            I.e: "param => { ... };"

            * runtime/TypeProfiler.cpp:
            (JSC::TypeProfiler::findLocation):
            * runtime/TypeProfiler.h:
            (JSC::QueryKey::QueryKey):
            (JSC::QueryKey::isHashTableDeletedValue):
            (JSC::QueryKey::operator==):
            (JSC::QueryKey::hash):
            * tests/typeProfiler/arrow-functions.js: Added.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r189415. rdar://problem/23221163

    2015-09-04  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Test Runtime.saveResult and $n values
            https://bugs.webkit.org/show_bug.cgi?id=148837

            Reviewed by Timothy Hatcher.

            * inspector/InjectedScriptSource.js:
            (InjectedScript.prototype._evaluateOn):
            We don't need to be in the console object group to put the value
            in the saved results list. That strong reference will ensure $n
            values are always alive even if other object groups were used
            when creating and subsequently released.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r189373. rdar://problem/23221163

    2015-09-04  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Expand Console domain test coverage
            https://bugs.webkit.org/show_bug.cgi?id=148740

            Reviewed by Brian Burg.

            * inspector/protocol/Console.json:
            Update the description of this command now that it only
            manipulates $0, and not $1, $2, .. $n.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r189104. rdar://problem/23221163

    2015-08-28  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Separate creating a style sheet from adding a new rule in the protocol
            https://bugs.webkit.org/show_bug.cgi?id=148502

            Reviewed by Timothy Hatcher.

            * inspector/protocol/CSS.json:
            Add CSS.createStyleSheet. Modify CSS.addRule.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r189002. rdar://problem/23221163

    2015-08-26  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Implement tracking of active stylesheets in the frontend
            https://bugs.webkit.org/show_bug.cgi?id=105828

            Reviewed by Timothy Hatcher.

            * inspector/protocol/CSS.json:
            Add new events for when a StyleSheet is added or removed.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r188965. rdar://problem/23221163

    2015-08-25  Brian Burg  <bburg@apple.com>

            Web Inspector: no need to allocate protocolErrors array for every dispatched backend command
            https://bugs.webkit.org/show_bug.cgi?id=146466

            Reviewed by Joseph Pecoraro.

            Clean up some of the backend dispatcher code, with a focus on eliminating useless allocations
            of objects in the common case when no protocol errors happen. This is done by saving the
            current id of each request as it is being processed by the backend dispatcher, and tagging any
            subsequent errors with that id. This also means we don't have to thread the requestId except
            in the async command code path.

            This patch also lifts some common code shared between all generated backend command
            implementatations into the per-domain dispatch method instead. This reduces generated code size.

            To be consistent, this patch standardizes on calling the id of a backend message its 'requestId'.
            Requests can be handled synchronously or asynchronously (triggered via the 'async' property).

            No new tests, covered by existing protocol tests.

            * inspector/InspectorBackendDispatcher.cpp:
            (Inspector::BackendDispatcher::CallbackBase::CallbackBase): Split the two code paths for reporting
            success and failure.

            (Inspector::BackendDispatcher::CallbackBase::sendFailure):
            (Inspector::BackendDispatcher::CallbackBase::sendSuccess): Renamed from sendIfActive.
            (Inspector::BackendDispatcher::dispatch): Reset counters and current requestId before dispatching.
            No need to manually thread the requestId to all reportProtocolError calls.

            (Inspector::BackendDispatcher::hasProtocolErrors): Added.
            (Inspector::BackendDispatcher::sendResponse):
            (Inspector::BackendDispatcher::sendPendingErrors): Send any saved protocol errors to the frontend.
            Always send a 'data' member with all of the errors, even if there's just one. We might want to add
            more information about errors later.

            (Inspector::BackendDispatcher::reportProtocolError): Enqueue a protocol error to be sent later.
            (Inspector::BackendDispatcher::getPropertyValue): Remove useless type parameters and nuke most of
            the type conversion methods. Use std::function types instead of function pointer types.

            (Inspector::castToInteger): Added.
            (Inspector::castToNumber): Added.
            (Inspector::BackendDispatcher::getInteger):
            (Inspector::BackendDispatcher::getDouble):
            (Inspector::BackendDispatcher::getString):
            (Inspector::BackendDispatcher::getBoolean):
            (Inspector::BackendDispatcher::getObject):
            (Inspector::BackendDispatcher::getArray):
            (Inspector::BackendDispatcher::getValue):
            (Inspector::getPropertyValue): Deleted.
            (Inspector::AsMethodBridges::asInteger): Deleted.
            (Inspector::AsMethodBridges::asDouble): Deleted.
            (Inspector::AsMethodBridges::asString): Deleted.
            (Inspector::AsMethodBridges::asBoolean): Deleted.
            (Inspector::AsMethodBridges::asObject): Deleted.
            (Inspector::AsMethodBridges::asArray): Deleted.
            (Inspector::AsMethodBridges::asValue): Deleted.
            * inspector/InspectorBackendDispatcher.h:
            * inspector/scripts/codegen/cpp_generator_templates.py: Extract 'params' object in domain dispatch method.
            Omit requestIds where possible. Convert dispatch tables to use NeverDestroyed. Check the protocol error count
            to decide whether to abort the dispatch or not, rather than allocating our own errors array.

            * inspector/scripts/codegen/cpp_generator_templates.py:
            (void):
            * inspector/scripts/codegen/generate_cpp_backend_dispatcher_header.py: Revert to passing RefPtr<InspectorObject>
            since parameters are now being passed rather than the message object. Some commands do not require parameters.
            * inspector/scripts/codegen/generate_cpp_backend_dispatcher_implementation.py:
            (CppBackendDispatcherImplementationGenerator.generate_output):
            (CppBackendDispatcherImplementationGenerator._generate_small_dispatcher_switch_implementation_for_domain):
            (CppBackendDispatcherImplementationGenerator._generate_dispatcher_implementation_for_command):
            * inspector/scripts/codegen/generate_objc_backend_dispatcher_header.py:
            (ObjCBackendDispatcherHeaderGenerator._generate_objc_handler_declaration_for_command):
            * inspector/scripts/codegen/generate_objc_backend_dispatcher_implementation.py:
            (ObjCConfigurationImplementationGenerator._generate_handler_implementation_for_command):
            (ObjCConfigurationImplementationGenerator._generate_success_block_for_command):
            * inspector/scripts/codegen/objc_generator_templates.py:

            Rebaseline some protocol generator tests.
            * inspector/scripts/tests/expected/commands-with-async-attribute.json-result:
            * inspector/scripts/tests/expected/commands-with-optional-call-return-parameters.json-result:
            * inspector/scripts/tests/expected/domains-with-varying-command-sizes.json-result:
            * inspector/scripts/tests/expected/enum-values.json-result:
            * inspector/scripts/tests/expected/events-with-optional-parameters.json-result:
            * inspector/scripts/tests/expected/generate-domains-with-feature-guards.json-result:
            * inspector/scripts/tests/expected/same-type-id-different-domain.json-result:
            * inspector/scripts/tests/expected/shadowed-optional-type-setters.json-result:
            * inspector/scripts/tests/expected/type-declaration-aliased-primitive-type.json-result:
            * inspector/scripts/tests/expected/type-declaration-array-type.json-result:
            * inspector/scripts/tests/expected/type-declaration-enum-type.json-result:
            * inspector/scripts/tests/expected/type-declaration-object-type.json-result:
            * inspector/scripts/tests/expected/type-requiring-runtime-casts.json-result:

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r188897. rdar://problem/23221163

    2015-08-24  Brian Burg  <bburg@apple.com>

            Web Inspector: add protocol test for existing error handling performed by the backend
            https://bugs.webkit.org/show_bug.cgi?id=147097

            Reviewed by Joseph Pecoraro.

            A new test revealed that the protocol "method" parameter was being parsed in a naive way.
            Rewrite it to use String::split and improve error checking to avoid failing later.

            * inspector/InspectorBackendDispatcher.cpp:
            (Inspector::BackendDispatcher::dispatch):

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r188631. rdar://problem/23221163

    2015-08-18  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Links for rules in <style> are incorrect, do not account for <style> offset in the document
            https://bugs.webkit.org/show_bug.cgi?id=148141

            Reviewed by Brian Burg.

            * inspector/protocol/CSS.json:
            Extend StyleSheetHeader to include start offset information and a bit
            for whether or not this was an inline style tag created by the parser.
            These match additions to Blink's protocol.

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r188549. rdar://problem/23221163

    2015-08-17  Saam barati  <sbarati@apple.com>

            Web Inspector: Type profiler return types aren't showing up
            https://bugs.webkit.org/show_bug.cgi?id=147348

            Reviewed by Brian Burg.

            Bug #145995 changed the starting offset of a function to
            be the open parenthesis of the function's parameter list.
            This broke JSC's type profiler protocol of communicating
            return types of a function to the web inspector. This
            is now fixed. The text offset used in the protocol is now
            the first letter of the function/get/set/method name.
            So "f" in "function a() {}", "s" in "set foo(){}", etc.

            * bytecode/CodeBlock.cpp:
            (JSC::CodeBlock::CodeBlock):
            * jsc.cpp:
            (functionReturnTypeFor):

2015-12-02  Timothy Hatcher  <timothy@apple.com>

        Merge r188403. rdar://problem/23221163

    2015-08-13  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: A {Map, WeakMap, Set, WeakSet} object contains itself will hang the console
            https://bugs.webkit.org/show_bug.cgi?id=147966

            Reviewed by Timothy Hatcher.

            * inspector/InjectedScriptSource.js:
            (InjectedScript.prototype._initialPreview):
            Renamed to initial preview. This is not a complete preview for
            this object, and it needs some processing in order to be a
            complete accurate preview.

            (InjectedScript.RemoteObject.prototype._emptyPreview):
            This attempts to be an accurate empty preview for the given object.
            For types with entries, it adds an empty entries list and updates
            the overflow and lossless properties.

            (InjectedScript.RemoteObject.prototype._createObjectPreviewForValue):
            Take a generatePreview parameter to generate a full preview or empty preview.

            (InjectedScript.RemoteObject.prototype._appendPropertyPreviews):
            (InjectedScript.RemoteObject.prototype._appendEntryPreviews):
            (InjectedScript.RemoteObject.prototype._isPreviewableObject):
            Take care to avoid cycles.

2015-12-01  Timothy Hatcher  <timothy@apple.com>

        Merge r187496. rdar://problem/23221163

    2015-07-28  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Show Pseudo Elements in DOM Tree
            https://bugs.webkit.org/show_bug.cgi?id=139612

            Reviewed by Timothy Hatcher.

            * inspector/protocol/DOM.json:
            Add new properties to DOMNode if it is a pseudo element or if it has
            pseudo element children. Add new events for if a pseudo element is
            added or removed dynamically to an existing DOMNode.

2015-12-01  Timothy Hatcher  <timothy@apple.com>

        Merge r187249. rdar://problem/23221163

    2015-07-23  Devin Rousso  <drousso@apple.com>

            Web Inspector: Add a function to CSSCompletions to get a list of supported system fonts
            https://bugs.webkit.org/show_bug.cgi?id=147009

            Reviewed by Joseph Pecoraro.

            * inspector/protocol/CSS.json: Added getSupportedSystemFontFamilyNames function.

2015-12-01  Timothy Hatcher  <timothy@apple.com>

        Merge r187211. rdar://problem/23221163

    2015-07-22  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Timeline should immediately start moving play head when starting a new recording
            https://bugs.webkit.org/show_bug.cgi?id=147210

            Reviewed by Timothy Hatcher.

            * inspector/protocol/Timeline.json:
            Add timestamps to recordingStarted and recordingStopped events.

2015-10-27  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r191395. rdar://problem/22847057

    2015-10-21  Filip Pizlo  <fpizlo@apple.com>

            Failures in PutStackSinkingPhase should be less severe
            https://bugs.webkit.org/show_bug.cgi?id=150400

            Reviewed by Geoffrey Garen.

            Make the PutStackSinkingPhase abort instead of asserting. To test that it's OK to not have
            PutStackSinkingPhase run, this adds a test mode where we run without PutStackSinkingPhase.

            * dfg/DFGPlan.cpp: Make it possible to not run PutStackSinkingPhase for tests.
            (JSC::DFG::Plan::compileInThreadImpl):
            * dfg/DFGPutStackSinkingPhase.cpp: PutStackSinkingPhase should abort instead of asserting, except when validation is enabled.
            * runtime/Options.h: Add an option for disabling PutStackSinkingPhase.

2015-10-27  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r187510. rdar://problem/22847057

    2015-07-28  Filip Pizlo  <fpizlo@apple.com>

            DFG::PutStackSinkingPhase should be more aggressive about its "no GetStack until put" rule
            https://bugs.webkit.org/show_bug.cgi?id=147371

            Reviewed by Mark Lam.

            Two fixes:

            - Make ConflictingFlush really mean that you can't load from the stack slot. This means not
              using ConflictingFlush for arguments.

            - Assert that a GetStack never sees ConflictingFlush.

            * dfg/DFGPutStackSinkingPhase.cpp:

2015-10-26  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r191530. rdar://problem/23206864

    2015-10-23  Michael Saboff  <msaboff@apple.com>

            REGRESSION (r179357-r179359): WebContent Crash using AOL Mail @ com.apple.JavascriptCore JSC::linkPolymorphicCall(JSC::ExecState*, JSC::CallLinkInfo&, JSC::CallVariant, JSC::RegisterPreservationMode) + 1584
            https://bugs.webkit.org/show_bug.cgi?id=150513

            Reviewed by Saam Barati.

            Add check in linkPolymorphicCall() to make sure we have a CodeBlock for the newly added variant.
            If not, we turn the call into a virtual call.

            The bug was caused by a stack overflow when preparing the function for execution.  This properly
            threw an exception, however linkPolymorphicCall() didn't check for this error case.

            Added a new test function "failNextNewCodeBlock()" to test tools to simplify the testing.

            * API/JSCTestRunnerUtils.cpp:
            (JSC::failNextNewCodeBlock):
            (JSC::numberOfDFGCompiles):
            * API/JSCTestRunnerUtils.h:
            * jit/Repatch.cpp:
            (JSC::linkPolymorphicCall):
            * jsc.cpp:
            (GlobalObject::finishCreation):
            (functionTransferArrayBuffer):
            (functionFailNextNewCodeBlock):
            (functionQuit):
            * runtime/Executable.cpp:
            (JSC::ScriptExecutable::prepareForExecutionImpl):
            * runtime/TestRunnerUtils.cpp:
            (JSC::optimizeNextInvocation):
            (JSC::failNextNewCodeBlock):
            (JSC::numberOfDFGCompiles):
            * runtime/TestRunnerUtils.h:
            * runtime/VM.h:
            (JSC::VM::setFailNextNewCodeBlock):
            (JSC::VM::getAndClearFailNextNewCodeBlock):
            (JSC::VM::stackPointerAtVMEntry):

2015-10-22  Matthew Hanson  <matthew_hanson@apple.com>

        Rollout r191395. rdar://problem/22847057

    2015-10-21  Filip Pizlo  <fpizlo@apple.com>

            Failures in PutStackSinkingPhase should be less severe
            https://bugs.webkit.org/show_bug.cgi?id=150400

            Reviewed by Geoffrey Garen.

            Make the PutStackSinkingPhase abort instead of asserting. To test that it's OK to not have
            PutStackSinkingPhase run, this adds a test mode where we run without PutStackSinkingPhase.

            * dfg/DFGPlan.cpp: Make it possible to not run PutStackSinkingPhase for tests.
            (JSC::DFG::Plan::compileInThreadImpl):
            * dfg/DFGPutStackSinkingPhase.cpp: PutStackSinkingPhase should abort instead of asserting, except when validation is enabled.
            * runtime/Options.h: Add an option for disabling PutStackSinkingPhase.

2015-10-22  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r191395. rdar://problem/22847057

    2015-10-21  Filip Pizlo  <fpizlo@apple.com>

            Failures in PutStackSinkingPhase should be less severe
            https://bugs.webkit.org/show_bug.cgi?id=150400

            Reviewed by Geoffrey Garen.

            Make the PutStackSinkingPhase abort instead of asserting. To test that it's OK to not have
            PutStackSinkingPhase run, this adds a test mode where we run without PutStackSinkingPhase.

            * dfg/DFGPlan.cpp: Make it possible to not run PutStackSinkingPhase for tests.
            (JSC::DFG::Plan::compileInThreadImpl):
            * dfg/DFGPutStackSinkingPhase.cpp: PutStackSinkingPhase should abort instead of asserting, except when validation is enabled.
            * runtime/Options.h: Add an option for disabling PutStackSinkingPhase.

2015-10-22  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r191364. rdar://problem/22862879

    2015-10-20  Mark Lam  <mark.lam@apple.com>

            YarrPatternConstructor::containsCapturingTerms() should not assume that its terms.size() is greater than 0.
            https://bugs.webkit.org/show_bug.cgi?id=150372

            Reviewed by Geoffrey Garen.

            * yarr/YarrPattern.cpp:
            (JSC::Yarr::CharacterClassConstructor::CharacterClassConstructor):
            (JSC::Yarr::YarrPatternConstructor::optimizeBOL):
            (JSC::Yarr::YarrPatternConstructor::containsCapturingTerms):
            (JSC::Yarr::YarrPatternConstructor::optimizeDotStarWrappedExpressions):

2015-10-13  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r189834. rdar://problem/22801966

    2015-09-15  Joseph Pecoraro  <pecoraro@apple.com>

            Web Inspector: Paused Debugger prevents page reload
            https://bugs.webkit.org/show_bug.cgi?id=148174

            Reviewed by Brian Burg.

            * debugger/Debugger.h:
            (JSC::Debugger::suppressAllPauses):
            (JSC::Debugger::setSuppressAllPauses):
            * debugger/Debugger.cpp:
            (JSC::Debugger::Debugger):
            (JSC::Debugger::pauseIfNeeded):
            * inspector/agents/InspectorDebuggerAgent.h:
            * inspector/agents/InspectorDebuggerAgent.cpp:
            (Inspector::InspectorDebuggerAgent::setSuppressAllPauses):
            Provide a way to suppress pauses.

2015-10-08  Lucas Forschler  <lforschler@apple.com>

        Merge r189454. rdar://problem/22802036

    2015-09-06  Mark Lam  <mark.lam@apple.com>

            StackOverflow stack unwinding should stop at native frames.
            https://bugs.webkit.org/show_bug.cgi?id=148749

            Reviewed by Michael Saboff.

            In the present code, after ping-pong'ing back and forth between native and JS
            code a few times, if we have a stack overflow on re-entry into the VM to run
            JS code's whose stack frame would overflow the JS stack, the code will end up
            unwinding past the native function that is making the call to re-enter the VM.
            As a result, any clean up code (e.g. destructors for stack variables) in the
            skipped native function frame (and its chain of native function callers) will
            not be called.

            This patch is based on the Michael Saboff's fix of this issue landed on the
            jsc-tailcall branch: http://trac.webkit.org/changeset/188555

            We now check for the case where there are no JS frames to unwind since the
            last native frame, and treat the exception as an unhandled exception.  The
            native function is responsible for further propagating the exception if needed.

            Other supporting work:
            1. Remove vm->vmEntryFrameForThrow.  It should always be the same as
               vm->topVMEntryFrame.
            2. Change operationThrowStackOverflowError() to use the throwStackOverflowError()
               helper function instead of rolling its own.
            3. Added a test that exercises this edge case.  The test should not hang or crash.

            * API/tests/PingPongStackOverflowTest.cpp: Added.
            (PingPongStackOverflowObject_hasInstance):
            (testPingPongStackOverflow):
            * API/tests/PingPongStackOverflowTest.h: Added.
            * API/tests/testapi.c:
            (main):
            * JavaScriptCore.xcodeproj/project.pbxproj:
            * interpreter/CallFrame.h:
            (JSC::ExecState::operator=):
            (JSC::ExecState::callerFrame):
            (JSC::ExecState::callerFrameOrVMEntryFrame):
            (JSC::ExecState::argIndexForRegister):
            (JSC::ExecState::callerFrameAndPC):
            * interpreter/Interpreter.cpp:
            (JSC::UnwindFunctor::UnwindFunctor):
            (JSC::UnwindFunctor::operator()):
            (JSC::Interpreter::unwind):
            * interpreter/Interpreter.h:
            (JSC::NativeCallFrameTracer::NativeCallFrameTracer):
            (JSC::Interpreter::sampler):
            * jit/CCallHelpers.h:
            (JSC::CCallHelpers::jumpToExceptionHandler):
            * jit/JITExceptions.cpp:
            (JSC::genericUnwind):
            * jit/JITExceptions.h:
            * jit/JITOpcodes.cpp:
            (JSC::JIT::emit_op_catch):
            * jit/JITOpcodes32_64.cpp:
            (JSC::JIT::emit_op_catch):
            * jit/JITOperations.cpp:
            * llint/LowLevelInterpreter32_64.asm:
            * llint/LowLevelInterpreter64.asm:
            * runtime/VM.h:
            (JSC::VM::exceptionOffset):
            (JSC::VM::callFrameForThrowOffset):
            (JSC::VM::vmEntryFrameForThrowOffset): Deleted.
            (JSC::VM::topVMEntryFrameOffset): Deleted.

2015-10-02  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r189460. rdar://problem/22802036

    2015-09-06  Mark Lam  <mark.lam@apple.com>

            Gardening: fix broken Windows build after r189454.

            Not reviewed.

            * JavaScriptCore.vcxproj/testapi/testapi.vcxproj:
            * JavaScriptCore.vcxproj/testapi/testapi.vcxproj.filters:

2015-09-03  Babak Shafiei  <bshafiei@apple.com>

        Merge r189046.

    2015-08-27  Basile Clement  <basile_clement@apple.com>

            REGRESSION(r184779): Possible read-after-free in JavaScriptCore/dfg/DFGClobberize.h
            https://bugs.webkit.org/show_bug.cgi?id=148411

            Reviewed by Geoffrey Garen and Filip Pizlo.

            * dfg/DFGClobberize.h:
            (JSC::DFG::clobberize):

2015-09-03  Babak Shafiei  <bshafiei@apple.com>

        Merge r188311.

    2015-08-11  Alexey Proskuryakov  <ap@apple.com>

            Make ASan build not depend on asan.xcconfig
            https://bugs.webkit.org/show_bug.cgi?id=147840
            rdar://problem/21093702

            Reviewed by Daniel Bates.

            * dfg/DFGOSREntry.cpp:
            (JSC::DFG::OSREntryData::dump):
            (JSC::DFG::prepareOSREntry):
            * ftl/FTLOSREntry.cpp:
            (JSC::FTL::prepareOSREntry):
            * heap/ConservativeRoots.cpp:
            (JSC::ConservativeRoots::genericAddPointer):
            (JSC::ConservativeRoots::genericAddSpan):
            * heap/MachineStackMarker.cpp:
            (JSC::MachineThreads::removeThreadIfFound):
            (JSC::MachineThreads::gatherFromCurrentThread):
            (JSC::MachineThreads::Thread::captureStack):
            (JSC::copyMemory):
            * interpreter/Register.h:
            (JSC::Register::operator=):
            (JSC::Register::asanUnsafeJSValue):
            (JSC::Register::jsValue):

2015-09-03  Babak Shafiei  <bshafiei@apple.com>

        Merge r188067.

    2015-08-06  Filip Pizlo  <fpizlo@apple.com>

            Structures used for tryGetConstantProperty() should be registered first
            https://bugs.webkit.org/show_bug.cgi?id=147750

            Reviewed by Saam Barati and Michael Saboff.

            * dfg/DFGGraph.cpp:
            (JSC::DFG::Graph::tryGetConstantProperty): Add an assertion to that effect. This should catch the bug sooner.
            * dfg/DFGGraph.h:
            (JSC::DFG::Graph::addStructureSet): Register structures when we make a structure set. That ensures that we won't call tryGetConstantProperty() on a structure that hasn't been registered yet.
            * dfg/DFGStructureRegistrationPhase.cpp:
            (JSC::DFG::StructureRegistrationPhase::run): Don't register structure sets here anymore. Registering them before we get here means there is no chance of the code being DCE'd before the structures get registered. It also enables the tryGetConstantProperty() assertion, since that code runs before StructureRegisterationPhase.
            (JSC::DFG::StructureRegistrationPhase::registerStructures):
            (JSC::DFG::StructureRegistrationPhase::registerStructure):
            (JSC::DFG::StructureRegistrationPhase::assertAreRegistered):
            (JSC::DFG::StructureRegistrationPhase::assertIsRegistered):
            (JSC::DFG::performStructureRegistration):

2015-08-27  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r189012. rdar://problem/22084478

    2015-08-26  Saam barati  <sbarati@apple.com>

            MarkedBlock::allocateBlock will have the wrong allocation size when (sizeof(MarkedBlock) + bytes) is divisible by WTF::pageSize()
            https://bugs.webkit.org/show_bug.cgi?id=148500

            Reviewed by Mark Lam.

            Consider the following scenario:
            - On OS X, WTF::pageSize() is 4*1024 bytes.
            - JSEnvironmentRecord::allocationSizeForScopeSize(6621) == 53000
            - sizeof(MarkedBlock) == 248
            - (248 + 53000) is a multiple of 4*1024.
            - (248 + 53000)/(4*1024) == 13

            We will allocate a chunk of memory of size 53248 bytes that looks like this:
            0            248       256                       53248       53256
            [Marked Block | 8 bytes |  payload     ......      ]  8 bytes  |
                                    ^                                      ^
                               Our Environment record starts here.         ^
                                                                           ^
                                                                     Our last JSValue in the environment record will go from byte 53248 to 53256. But, we don't own this memory.

            We need to ensure that we round up sizeof(MarkedBlock) to an
            atomSize boundary. We need to do this because the first atom
            inside the MarkedBlock will start at the rounded up multiple
            of atomSize past MarkedBlock. If we end up with an allocation
            that is perfectly aligned to the page size, then we will be short
            8 bytes (in the current implementation where atomSize is 16 bytes,
            and MarkedBlock is 248 bytes).

            * heap/MarkedAllocator.cpp:
            (JSC::MarkedAllocator::allocateBlock):
            * tests/stress/heap-allocator-allocates-incorrect-size-for-activation.js: Added.
            (use):
            (makeFunction):

2015-07-31  Lucas Forschler  <lforschler@apple.com>

        Merge r187579

    2015-07-29  Filip Pizlo  <fpizlo@apple.com>

            DFG::ArgumentsEliminationPhase should emit a PutStack for all of the GetStacks that the ByteCodeParser emitted
            https://bugs.webkit.org/show_bug.cgi?id=147433
            rdar://problem/21668986

            Reviewed by Mark Lam.

            Ideally, the ByteCodeParser would only emit SetArgument nodes for named arguments.  But
            currently that's not what it does - it emits a SetArgument for every argument that a varargs
            call may pass.  Each SetArgument gets turned into a GetStack.  This means that if
            ArgumentsEliminationPhase optimizes away PutStacks for those varargs arguments that didn't
            get passed or used, we get degenerate IR where we have a GetStack of something that didn't
            have a PutStack.

            This fixes the bug by removing the code to optimize away PutStacks in
            ArgumentsEliminationPhase.

            * dfg/DFGArgumentsEliminationPhase.cpp:
            * tests/stress/varargs-inlining-underflow.js: Added.
            (baz):
            (bar):
            (foo):

2015-07-24  Matthew Hanson  <matthew_hanson@apple.com>

        Merge r187139. rdar://problem/21847618

    2015-07-21  Filip Pizlo  <fpizlo@apple.com>

            Unreviewed, fix a lot of tests. Need to initialize WTF threading sooner.

            * jsc.cpp:
            (main):

2015-07-23  Lucas Forschler  <lforschler@apple.com>

        Merge r187125

    2015-07-21  Filip Pizlo  <fpizlo@apple.com>

            Fixed VM pool allocation should have a reserve for allocations that cannot fail
            https://bugs.webkit.org/show_bug.cgi?id=147154
            rdar://problem/21847618

            Reviewed by Geoffrey Garen.

            This adds the notion of a JIT pool reserve fraction. Some fraction, currently 1/4, of
            the JIT pool is reserved for allocations that cannot fail. It makes sense to make this
            a fraction rather than a constant because each allocation that can fail may cause some
            number of allocations that cannot fail (for example, the OSR exit thunks that we
            compile when we exit from some CodeBlock cannot fail).

            I've tested this by adding a test mode where we artificially limit the JIT pool size.
            Prior to the fix, we had >20 failures. Now we have none.

            * heap/GCLogging.cpp:
            (WTF::printInternal): I needed a dump method on Options members when debugging this.
            * heap/GCLogging.h:
            * jit/ExecutableAllocator.h: Raise the ARM64 limit to 32MB because 16MB is cutting it too close.
            * jit/ExecutableAllocatorFixedVMPool.cpp:
            (JSC::FixedVMPoolExecutableAllocator::FixedVMPoolExecutableAllocator): Add the ability to artificially limit JIT pool size for testing.
            (JSC::ExecutableAllocator::memoryPressureMultiplier): Implement the reserve when computing memory pressure for JIT tier-up heuristics.
            (JSC::ExecutableAllocator::allocate): Implement the reserve when allocating can-fail things.
            * jsc.cpp: Rewire some options parsing so that CommandLine happens before we create the JIT pool.
            (main):
            (CommandLine::parseArguments):
            (jscmain):
            * runtime/Options.cpp:
            (JSC::OptionRange::dump): I needed a dump method on Options members when debugging this.
            (JSC::Options::initialize): This can now be called more than once.
            * runtime/Options.h:

== Rolled over to ChangeLog-2015-07-23 ==
